# Self-Hosted SERP Scraper Deployment
# Docker Compose for Novexity and SearxNG

version: '3.8'

services:
  # =============================================
  # NOVEXITY - Primary SERP Scraper
  # Open-source SerpAPI alternative
  # =============================================
  novexity:
    build:
      context: .
      dockerfile: Dockerfile.novexity
    container_name: novexity
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - NODE_ENV=production
      - PORT=8000
      # Optional: Add proxy configuration
      # - PROXY_URL=http://your-proxy:port
      # - PROXY_USERNAME=user
      # - PROXY_PASSWORD=pass
    volumes:
      - ./data/novexity:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - serp-network

  # =============================================
  # SEARXNG - Fallback Metasearch Engine
  # Privacy-respecting search aggregator
  # =============================================
  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - SEARXNG_BASE_URL=http://localhost:8080
      - SEARXNG_SECRET=your-secret-key-change-this
    volumes:
      - ./config/searxng:/etc/searxng:rw
      - ./data/searxng:/var/log/searxng:rw
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    networks:
      - serp-network

  # =============================================
  # REDIS - Caching Layer (Optional)
  # For shared caching across instances
  # =============================================
  redis:
    image: redis:alpine
    container_name: serp-cache
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    command: redis-server --appendonly yes
    networks:
      - serp-network

networks:
  serp-network:
    driver: bridge

# =============================================
# VOLUMES FOR PERSISTENCE
# =============================================
volumes:
  novexity-data:
  searxng-config:
  searxng-data:
  redis-data:
